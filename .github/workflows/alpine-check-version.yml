name: Chore - Check version of Alpine linux

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

jobs:
  check-alpine-versions:
    runs-on: ubuntu-latest
    outputs:
      update_alpine: ${{ steps.compare.outputs.update_alpine }}
    steps:
      - uses: actions/checkout@v4

      - name: Load .env and export variable
        id: load-env
        run: |
          set -a
          source .env
          set +a
          echo "alpine_version=$ALPINE_VERSION" >> $GITHUB_OUTPUT

      - name: Get latest Alpine version
        id: latest-version
        run: |
          ALPINE_DIGEST="$(curl -s 'https://hub.docker.com/v2/repositories/library/alpine/tags?name=latest' | jq -r '.results[] | select(.name == "latest") | .digest')"
          ALPINE_LATEST_VERSION="$(curl -s 'https://hub.docker.com/v2/repositories/library/alpine/tags?page_size=100' \
          | jq -r '.results[] | select(.digest == "'$ALPINE_DIGEST'") | select(.name | test("^[0-9]+\\.[0-9]+$")) | .name' \
          | head -n 1)"

          : "${ALPINE_LATEST_VERSION:?Error: Unable to fetch current Alpine version}"

          echo "version=${ALPINE_LATEST_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Compare ALPINE_VERSION and ALPINE_LATEST_VERSION
        id: compare
        run: |
          if [ "${{ steps.load-env.outputs.alpine_version }}" = "${{ steps.latest-version.outputs.version }}" ]; then
            echo "::notice::Versions match. Exiting."
            exit 0
          else
            echo "::notice::New version. Create commit and PR."
            echo "update_alpine=${{ steps.latest-version.outputs.version }}" >> "$GITHUB_OUTPUT"
          fi

  create-pull-request:
    needs: check-alpine-versions
    runs-on: ubuntu-latest
    if: ${{ needs.check-alpine-versions.outputs.update_alpine }}
    steps:
      - uses: actions/checkout@v4

      - name: Update .env
        run: |
          sed -i 's/^ALPINE_VERSION=.*/ALPINE_VERSION=${{ needs.check-alpine-versions.outputs.update_alpine }}/' .env
          cat .env

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add .
          git commit -m "ðŸ“¦ chore(deps): bump Alpine Linux to ${{ needs.check-alpine-versions.outputs.update_alpine }}"

      - name: Push changes
        if: ${{ steps.compare.outputs.update_alpine == 'true' }}
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/update-alpine-linux-${{ needs.check-alpine-versions.outputs.update_alpine }}

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/update-alpine-linux-${{ needs.check-alpine-versions.outputs.update_alpine }}
          title: "[GithubActions] New Alpine Linux version `${{ needs.check-alpine-versions.outputs.update_alpine }}`"
          body: |
            Automatically generated by a GitHub Action.

              - Updates the Alpine Linux base image to version `${{ needs.check-alpine-versions.outputs.update_alpine }}`.
